#!/usr/bin/env bash

# This script sets up a Git hook for commit messages in the current workspace.`

WORKSPACE="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

git_hook() {
  local hook_name="$1"
  local hook_path="$WORKSPACE/.git/hooks/"
  local hook_file="$hook_path/$hook_name"

  [ -d "$WORKSPACE/.git" ] || { echo "No .git directory found in $WORKSPACE"; exit 1; }
  [ -d "$hook_path" ] || mkdir -p "$hook_path"

  cat >"$hook_file"
  chmod +x "$hook_file"
}

git_hook commit-msg <<-EOF
	#!/usr/bin/env bash
	WORKSPACE="\$( cd -- "\$( dirname -- "\${BASH_SOURCE[0]}" )/../.." &> /dev/null && pwd )"
	[ -s "\$WORKSPACE/package.json" ] || { echo "No package.json found in \$WORKSPACE"; exit 1; }
	version=\$(grep '"version"' "\$WORKSPACE/package.json" | head -1 | sed -E 's/.*"version": *"([^"]+)".*/\1/' || echo "0.0.0")
	if [[ "\$1" != "\$version"* ]]; then
	  echo "ERROR: Commit message must include the version number \$version from package.json."
	  exit 1
	fi
	if ! grep -q "\$version" "\$WORKSPACE/README.md"; then
	  echo "ERROR: README.md does not mention version $version"
	  exit 2
	fi
EOF

[ -d "$WORKSPACE/node_modules" ] || npm install
